<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ç®¡ç†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        
        .controls a, .controls button {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background: #4CAF50;
            color: white;
            text-decoration: none;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .controls a:hover, .controls button:hover {
            background: #45a049;
        }
        .controls a:hover, .controls button:hover {
            background: #45a049;
        }
        
        .stats {
            background: white;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .file-table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .file-table th, .file-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .file-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .file-table tr:hover {
            background: #f5f5f5;
        }
        
        /* ç®€å•ç›´æ¥çš„æŒ‰é’®æ ·å¼ */
        .download-btn {
            background: #28a745 !important;
            color: white !important;
            padding: 8px 15px !important;
            border: none !important;
            border-radius: 3px !important;
            cursor: pointer !important;
            margin-right: 5px !important;
            font-size: 12px !important;
            display: inline-block !important;
            text-decoration: none !important;
        }
        
        .delete-btn {
            background: #dc3545 !important;
            color: white !important;
            padding: 8px 15px !important;
            border: none !important;
            border-radius: 3px !important;
            cursor: pointer !important;
            font-size: 12px !important;
            display: inline-block !important;
            text-decoration: none !important;
        }
        
        .download-btn:hover {
            background: #218838 !important;
        }
        
        .delete-btn:hover {
            background: #c82333 !important;
        }
        
        .loading, .error, .empty {
            text-align: center;
            padding: 40px;
            background: white;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .error {
            color: red;
            background: #ffe6e6 !important;
        }
    </style>
</head>
<body>
    <h1>ğŸ“ æ–‡ä»¶ç®¡ç†ç³»ç»Ÿ</h1>
    
    <div class="controls">
        <a href="/upload.html">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</a>
        <button id="refreshBtn">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        <a href="/index.html">ğŸ  è¿”å›é¦–é¡µ</a>
    </div>
    
    <div class="stats">
        <strong>æ–‡ä»¶æ€»æ•°:</strong> <span id="fileCount">-</span> &nbsp;&nbsp;&nbsp;
        <strong>æœ€åæ›´æ–°:</strong> <span id="lastUpdate">-</span>
    </div>
    
    <div id="loadingDiv" class="loading">
        ğŸ”„ æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...
    </div>
    
    <div id="errorDiv" class="error" style="display: none;"></div>
    
    <table id="fileTable" class="file-table" style="display: none;">
        <thead>
            <tr>
                <th>ğŸ“„ æ–‡ä»¶å</th>
                <th style="width: 200px;">ğŸ› ï¸ æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="fileTableBody"></tbody>
    </table>
    
    <div id="emptyState" class="empty" style="display: none;">
        <h3>ğŸ“‚ æš‚æ— æ–‡ä»¶</h3>
        <p>è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ–‡ä»¶ï¼Œ<a href="/upload.html">ç«‹å³ä¸Šä¼ </a>ç¬¬ä¸€ä¸ªæ–‡ä»¶å§ï¼</p>
    </div>

    <script>
        let fileList = [];
        let currentUsername = '';
        
        // ä»Cookieä¸­è·å–ç”¨æˆ·å
        function getUsernameFromCookie() {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith('username=')) {
                    return cookie.substring('username='.length);
                }
            }
            return '';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            console.log('é¡µé¢å·²åŠ è½½');
            
            // è·å–å½“å‰ç”¨æˆ·å
            currentUsername = getUsernameFromCookie();
            console.log('å½“å‰ç”¨æˆ·:', currentUsername);
            
            if (!currentUsername) {
                showError('æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                return;
            }
            
            loadFiles();
            
            // ç»‘å®šåˆ·æ–°æŒ‰é’®
            document.getElementById('refreshBtn').onclick = function() {
                console.log('åˆ·æ–°æŒ‰é’®è¢«ç‚¹å‡»');
                loadFiles();
            };
        };
        
        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        function loadFiles() {
            console.log('å¼€å§‹åŠ è½½æ–‡ä»¶');
            showLoading();
            
            fetch('/api/files')
                .then(function(response) {
                    console.log('æ”¶åˆ°å“åº”:', response.status);
                    return response.json();
                })
                .then(function(data) {
                    console.log('æ”¶åˆ°æ•°æ®:', data);
                    if (Array.isArray(data)) {
                        fileList = data;
                        showFiles(data);
                        updateStats(data.length);
                    } else {
                        showError('æ•°æ®æ ¼å¼é”™è¯¯');
                    }
                })
                .catch(function(error) {
                    console.error('åŠ è½½å¤±è´¥:', error);
                    showError('åŠ è½½å¤±è´¥: ' + error.message);
                });
        }
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('errorDiv').style.display = 'none';
            document.getElementById('fileTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            console.log('æ˜¾ç¤ºé”™è¯¯:', message);
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorDiv').style.display = 'block';
            document.getElementById('errorDiv').innerHTML = 'âŒ ' + message;
            document.getElementById('fileTable').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        function showFiles(files) {
            console.log('æ˜¾ç¤ºæ–‡ä»¶ï¼Œæ•°é‡:', files.length);
            
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('errorDiv').style.display = 'none';
            
            if (files.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('fileTable').style.display = 'none';
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('fileTable').style.display = 'table';
            
            var tbody = document.getElementById('fileTableBody');
            tbody.innerHTML = '';
            
            for (var i = 0; i < files.length; i++) {
                var filename = files[i];
                console.log('å¤„ç†æ–‡ä»¶:', filename);
                
                var row = tbody.insertRow();
                
                // æ–‡ä»¶ååˆ— - ç‚¹å‡»æ–‡ä»¶åç›´æ¥æ‰“å¼€æ–‡ä»¶
                var nameCell = row.insertCell(0);
                var fileUrl = '/upload/' + encodeURIComponent(currentUsername) + '/' + encodeURIComponent(filename);
                nameCell.innerHTML = getFileIcon(filename) + ' <a href="' + fileUrl + '" target="_blank" style="color: #007bff; text-decoration: underline;">' + 
                    escapeHtml(filename) + '</a>';
                
                // æ“ä½œåˆ—
                var actionCell = row.insertCell(1);
                actionCell.innerHTML = 
                    '<button class="download-btn" onclick="downloadFile(\'' + 
                    filename.replace(/'/g, "\\'") + '\')">ğŸ“¥ ä¸‹è½½</button>' +
                    '<button class="delete-btn" onclick="deleteFile(\'' + 
                    filename.replace(/'/g, "\\'") + '\')">ğŸ—‘ï¸ åˆ é™¤</button>';
            }
            
            console.log('æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤ºå®Œæˆ');
        }
        
        // æ›´æ–°ç»Ÿè®¡
        function updateStats(count) {
            document.getElementById('fileCount').textContent = count;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }
        
        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(filename) {
            var ext = filename.toLowerCase().split('.').pop();
            var icons = {
                'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸',
                'pdf': 'ğŸ“„', 'doc': 'ğŸ“', 'docx': 'ğŸ“', 'txt': 'ğŸ“„',
                'zip': 'ğŸ—œï¸', 'rar': 'ğŸ—œï¸',
                'mp3': 'ğŸµ', 'wav': 'ğŸµ',
                'mp4': 'ğŸ¬', 'avi': 'ğŸ¬'
            };
            return icons[ext] || 'ğŸ“„';
        }
        
        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(filename) {
            console.log('ä¸‹è½½æ–‡ä»¶:', filename);
            console.log('å½“å‰ç”¨æˆ·:', currentUsername);
            
            if (!currentUsername) {
                alert('âŒ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•ä¸‹è½½æ–‡ä»¶');
                return;
            }
            
            // åç«¯ä¼šä»cookieä¸­è‡ªåŠ¨è·å–ç”¨æˆ·åï¼Œæ— éœ€ä¼ é€’userå‚æ•°
            var url = '/api/download?file=' + encodeURIComponent(filename);
            console.log('ä¸‹è½½åœ°å€:', url);
            window.open(url, '_blank');
        }
        
        // åˆ é™¤æ–‡ä»¶
        function deleteFile(filename) {
            console.log('åˆ é™¤æ–‡ä»¶:', filename);
            console.log('å½“å‰ç”¨æˆ·:', currentUsername);
            
            if (!currentUsername) {
                alert('âŒ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•åˆ é™¤æ–‡ä»¶');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "' + filename + '" å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            // åç«¯ä¼šä»cookieä¸­è‡ªåŠ¨è·å–ç”¨æˆ·åï¼Œæ— éœ€ä¼ é€’userå‚æ•°
            var url = '/api/delete?file=' + encodeURIComponent(filename);
            console.log('åˆ é™¤åœ°å€:', url);
            
            fetch(url)
                .then(function(response) {
                    console.log('åˆ é™¤å“åº”:', response.status);
                    return response.json();
                })
                .then(function(data) {
                    console.log('åˆ é™¤ç»“æœ:', data);
                    if (data.success) {
                        alert('âœ… æ–‡ä»¶åˆ é™¤æˆåŠŸï¼');
                        loadFiles();
                    } else {
                        alert('âŒ åˆ é™¤å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(function(error) {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    alert('âŒ åˆ é™¤å¤±è´¥: ç½‘ç»œé”™è¯¯');
                });
        }
    </script>
</body>
</html>
